<style>
  .image-root{padding:var(--gutter-md)}
  .img{max-width:100%;height:auto;border:1px solid var(--color-border);background:var(--color-muted)}
</style>

<h1 class="font-lg text-foreground">Image (lazy + fallback)</h1>
<div data-component="image" class="image-root">
  <img data-src="" alt="Example" class="img" loading="lazy" data-img>
  <div data-fallback style="display:none;padding:8px;background:var(--color-card);color:var(--color-card-foreground)">Image non disponible</div>
</div>

<script type="module" lang="ts">
  import { core } from '$lib/core-engine.ts';
  core.registerComponent('image', {
    script: (root) => {
      const rootEl = (root instanceof Element) ? root : (root as any).node || document;
      const img = rootEl.querySelector('[data-img]') as HTMLImageElement | null;
      const fallback = rootEl.querySelector('[data-fallback]') as HTMLElement | null;
      if (!img) return;
      const src = img.getAttribute('data-src') || img.getAttribute('src') || '';
      if (!src){ if (fallback) fallback.style.display='block'; return; }
      img.src = src;
      img.onerror = ()=>{ if (fallback) fallback.style.display='block'; img.style.display='none'; };
      img.onload = ()=>{ if (fallback) fallback.style.display='none'; img.style.display='block'; };
      return () => { try{ img.onload = null; img.onerror = null; }catch(e){} };
    }, props:{}, resources:[], on:{}, meta:{description:'Image with lazy loading and fallback'}
  });
</script>
