<style>
    .accordion-root{padding:var(--gutter-md);font-size:var(--font-md);color:var(--color-foreground)}
    .accordion{width:100%;max-width:640px;margin:var(--gutter-sm) 0}
    .accordion-item{border:1px solid var(--color-border);margin-bottom:6px;background:var(--color-card);color:var(--color-card-foreground)}
    .accordion-header{background:var(--color-secondary);padding:var(--gutter-sm);cursor:pointer;border:0;width:100%;text-align:left}
    .accordion-content{display:none;padding:var(--gutter-sm);background:var(--color-card)}
    .accordion-content[aria-hidden="false"]{display:block}
</style>

<h1 class="font-lg text-foreground">Accordion</h1>
<div data-component="accordion" class="accordion accordion-root">
    <div class="accordion-item">
        <button data-accordion-header class="accordion-header" aria-expanded="false">Section 1</button>
        <div data-accordion-content class="accordion-content" aria-hidden="true">
            <p>This is the content for section 1.</p>
        </div>
    </div>
    <div class="accordion-item">
        <button data-accordion-header class="accordion-header" aria-expanded="false">Section 2</button>
        <div data-accordion-content class="accordion-content" aria-hidden="true">
            <p>This is the content for section 2.</p>
        </div>
    </div>
    <div class="accordion-item">
        <button data-accordion-header class="accordion-header" aria-expanded="false">Section 3</button>
        <div data-accordion-content class="accordion-content" aria-hidden="true">
            <p>This is the content for section 3.</p>
        </div>
    </div>
</div>

<script type="module" lang="ts">
    import { be, core } from '$lib/core-engine.ts';

    core.registerComponent('accordion', {
        props: {},
        resources: [],
        script: (root, props) => {
            const rootEl = (root instanceof Element) ? root : (root as any).node || document;
            const headers = Array.from(rootEl.querySelectorAll('[data-accordion-header]')) as HTMLElement[];
            if (!headers.length) return;

            const handlers: Function[] = [];

            function makeToggle(header: HTMLElement){
                return () => {
                    const content = header.nextElementSibling as HTMLElement | null;
                    if (!content) return;
                    const expanded = header.getAttribute('aria-expanded') === 'true';
                    header.setAttribute('aria-expanded', String(!expanded));
                    content.setAttribute('aria-hidden', String(expanded));
                };
            }

            headers.forEach((h)=>{
                const fn = makeToggle(h);
                handlers.push(fn);
                be(h).on('click', fn);
            });

            // return cleanup per SPECS
            return () => {
                headers.forEach((h, i)=>{ try{ be(h).off('click', handlers[i]); }catch(e){} });
            };
        },
        on: {},
        meta: { author: 'idae-html', version: '1.0.0', description: 'Accordion with proper cleanup and ARIA.' }
    });
</script>