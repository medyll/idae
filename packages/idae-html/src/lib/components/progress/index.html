<style>
  .progress-root{padding:var(--gutter-md);font-size:var(--font-md);color:var(--color-foreground)}
  .bar{width:100%;background:var(--color-muted);height:18px;border-radius:9px;overflow:hidden}
  .fill{height:100%;background:linear-gradient(90deg,var(--color-primary),color-mix(in srgb, var(--color-primary) 50%, var(--color-accent) 50%));width:0%}
  .spinner{width:32px;height:32px;border-radius:50%;border:4px solid var(--color-muted);border-top-color:var(--color-primary);animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
</style>

<h1 class="font-lg text-foreground">Progress / Spinner</h1>
<div data-component="progress" class="progress-root">
  <div class="card bg-card pad-md border-sm border-color-border">
    <h3>Determinate</h3>
    <div class="bar"><div data-fill class="fill"></div></div>
    <button data-start>Start</button>
  </div>

  <div class="card">
    <h3>Indeterminate spinner</h3>
    <div data-spin class="spinner" aria-hidden="false"></div>
    <button data-toggle>Toggle spinner</button>
  </div>
</div>

<script type="module" lang="ts">
  import { be, core } from '$lib/core-engine.js';

  core.registerComponent('progress', {
    script: (root, props)=> {
    const rootEl = (root instanceof Element) ? root : (root as any).node || document;
    const fillEl = rootEl.querySelector('[data-fill]') as HTMLElement | null;
    const startEl = rootEl.querySelector('[data-start]') as HTMLElement | null;
    const spinEl = rootEl.querySelector('[data-spin]') as HTMLElement | null;
    const toggleEl = rootEl.querySelector('[data-toggle]') as HTMLElement | null;
    if (!fillEl || !startEl || !spinEl || !toggleEl) return;

    const fillBe = be(fillEl);
    let p = 0; let interval: any = null;

    function onStart(){
      p = 0; fillBe.setStyle({ width: '0%' }); clearInterval(interval);
      interval = setInterval(()=>{ p += 5; fillBe.setStyle({ width: p + '%' }); if (p>=100) clearInterval(interval); }, 200);
    }

    function onToggle(){
      const show = (spinEl.style.display === 'none') ? 'inline-block' : 'none';
      be(spinEl).setStyle({ display: show });
    }

    be(startEl).on('click', onStart);
    be(toggleEl).on('click', onToggle);

    // cleanup function returned per SPECS
    return () => {
      clearInterval(interval);
      try{ be(startEl).off('click', onStart); }catch(e){}
      try{ be(toggleEl).off('click', onToggle); }catch(e){}
    };
  },
    props: {},
    resources: [],
    on: {},
    meta: {
      author: 'idae-html',
      version: '1.0.0',
      description: 'A progress bar and spinner component for indicating loading states.'
    }
  });
</script>
