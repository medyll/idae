<style>
  .dropdown-root{padding:var(--gutter-md);font-size:var(--font-md);color:var(--color-foreground)}
  .menu{border:1px solid var(--color-border);background:var(--color-popover);padding:4px;position:absolute}
  .item{padding:6px 12px;cursor:pointer}
  .item[aria-selected="true"]{background:var(--color-secondary)}
</style>

<h1 class="font-lg text-foreground">Dropdown</h1>
<div data-component="dropdown" class="dropdown-root" style="position:relative;display:inline-block">
  <button data-trigger aria-haspopup="true" aria-expanded="false">Select an option</button>
  <div data-menu class="menu" role="listbox" aria-hidden="true" style="display:none;min-width:160px">
    <div class="item" role="option" tabindex="0">Option A</div>
    <div class="item" role="option" tabindex="0">Option B</div>
    <div class="item" role="option" tabindex="0">Option C</div>
  </div>
</div>

<script type="module" lang="ts">
  import { be, core } from '$lib/core-engine.ts';

  core.registerComponent('dropdown', {
    script: (root, props)=> {
    const rootEl = (root instanceof Element) ? root : (root as any).node || document;
    const triggerEl = rootEl.querySelector('[data-trigger]') as HTMLElement | null;
    const menuEl = rootEl.querySelector('[data-menu]') as HTMLElement | null;
    if (!triggerEl || !menuEl) return;

    const triggerBe = be(triggerEl);
    const menuBe = be(menuEl);
    let items: HTMLElement[] = Array.from(menuEl.querySelectorAll('.item')) as HTMLElement[];
    let open = false; let focused = 0;

    function show(){ menuBe.setStyle({ display: 'block' }).setAttr('aria-hidden','false'); triggerBe.setAttr('aria-expanded','true'); open=true; if (items[0]) items[0].focus(); }
    function hide(){ menuBe.setStyle({ display: 'none' }).setAttr('aria-hidden','true'); triggerBe.setAttr('aria-expanded','false'); open=false; }

    function onTriggerClick(){ open? hide() : show(); }

    function onMenuKey(e: KeyboardEvent){
      if (e.key === 'ArrowDown'){ focused = (focused+1)%items.length; items[focused].focus(); e.preventDefault(); }
      if (e.key === 'ArrowUp'){ focused = (focused-1+items.length)%items.length; items[focused].focus(); e.preventDefault(); }
      if (e.key === 'Enter'){ select(document.activeElement as HTMLElement); }
      if (e.key === 'Escape'){ hide(); triggerEl.focus(); }
    }

    function onItemClick(it: HTMLElement){ return () => select(it); }
    function onItemFocus(idx: number){ return () => { focused = idx; }; }

    function select(el){
      if (!el || !(el instanceof HTMLElement)) return;
      items.forEach(i=> be(i).deleteAttr('aria-selected'));
      be(el).setAttr('aria-selected','true');
      triggerBe.updateText(el.textContent || '');
      hide();
      triggerEl.focus();
    }

    function onBodyClick(e: MouseEvent){ if (!menuEl.contains(e.target as Node) && e.target !== triggerEl) hide(); }

    // attach
    be(triggerEl).on('click', onTriggerClick);
    be(menuEl).on('keydown', onMenuKey);
    items.forEach((it, idx)=>{
      be(it).on('click', onItemClick(it));
      be(it).on('focus', onItemFocus(idx));
    });
    be(document.body).on('click', onBodyClick);

    return () => {
      try{ be(triggerEl).off('click', onTriggerClick); }catch(e){}
      try{ be(menuEl).off('keydown', onMenuKey); }catch(e){}
      items.forEach((it, idx)=>{
        try{ be(it).off('click', onItemClick(it)); }catch(e){}
        try{ be(it).off('focus', onItemFocus(idx)); }catch(e){}
      });
      try{ be(document.body).off('click', onBodyClick); }catch(e){}
    };
  },
    props: {},
    resources: [],
    on: {},
    meta: {
      author: 'idae-html',
      version: '1.0.0',
      description: 'A dropdown component with keyboard navigation and accessibility features.'
    }
  });
</script>
